---
title: "å¦‚ä½•ä½¿ç”¨ Vercel + Next.js å®ç° Link Preview ç»„ä»¶"
date: "2021-08-11"
---

# ä¾‹å­ ğŸŒ°

```tsx
<LinkPreview url="https://github.com/pengx17" />
```

ä¼šè¢«æ¸²æŸ“ä¸º â¡

<LinkPreview url="https://github.com/pengx17" />

<LinkPreview url="https://github.com/vercel/swr/issues/1904" />

åŒæ—¶ï¼Œå°†é¼ æ ‡ç§»åŠ¨åˆ°æœ¬ç«™çš„å¤–é“¾ï¼Œä¹Ÿä¼šå±•ç¤ºé¢„è§ˆä¿¡æ¯ã€‚ä½ å¯ä»¥è¯•ç€ç§»åŠ¨é¼ æ ‡åˆ°ä¸‹é¢çš„é“¾æ¥ï¼š

[Discord](https://discord.com/)

# å®ç°ç»†èŠ‚

UI ç»„ä»¶æœ¬èº«ååˆ†ç®€å•ï¼ŒæŠŠç›®æ ‡ URL ç›¸å…³ç‰¹å¾ï¼Œå¦‚æ ‡é¢˜ã€æè¿°ã€favicon ç­‰ä¿¡æ¯é€šè¿‡ API è·å–åï¼Œä»¥ HTML çš„å½¢å¼æ¸²æŸ“å³å¯ã€‚

```tsx
export default function LinkPreview({ url }: { url: string }) {
  const { data, error } = useSWR(url, fetcher);

  return (
    <>
      <div>{!(error || data) && url && "âŒ›"}</div>
      <div>
        <strong>{error}</strong>
      </div>

      {data && <PreviewCard data={data} />}
    </>
  );
}
```

é—®é¢˜åœ¨äºå¦‚ä½•æå–ç›®æ ‡ URL çš„ç›¸å…³ç‰¹å¾ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [OpenGraph Protocol](https://ogp.me/) è¿™é¡¹åè®®ï¼Œä»ç›®æ ‡é¡µé¢ä¸­çš„ `HEAD` é‡Œè·å–åˆ°ç›¸å…³ä¿¡æ¯ã€‚å…¶ç»†èŠ‚æˆ‘ä»¬ä¸å¤šè¯´ï¼Œå®é™…ä¸Šæˆ‘ä»¬åœ¨å„ç§æ¸ é“çœ‹åˆ°çš„å¡ç‰‡å¼é“¾æ¥çš„èƒŒåï¼Œéƒ½æœ‰è¿™ç§æŠ€æœ¯çš„å½±å­ã€‚

å¯¹äº [twitter.com/pengx17](https://twitter.com/pengx17)ï¼Œæˆ‘ä»¬åœ¨é¡µé¢æ¸²æŸ“å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ JS è·å–ç›¸å…³ OGP ä¿¡æ¯ï¼š

```js
Object.fromEntries(
  Array.from(document.querySelectorAll("meta"))
    .filter((e) => e.getAttribute("property")?.includes("og:"))
    .map((e) => [e.getAttribute("property"), e.getAttribute("content")])
);

res = {
  "og:site_name": "Twitter",
  "og:type": "profile",
  "og:url": "https://twitter.com/pengx17",
  "og:image":
    "https://pbs.twimg.com/profile_images/1171002374481051649/U8bFnWXt_normal.jpg",
  "og:title": "pengx17 (@pengx17) / Twitter",
};
```

[link-preview-js](https://github.com/ospfranco/link-preview-js) è¿™ä¸ª Node.js åº“å¯ä»¥æ–¹ä¾¿çš„å®ç°æˆ‘ä»¬çš„éœ€æ±‚ï¼ŒæŠŠç›®æ ‡ URL çš„ç›¸å…³ç‰¹å¾ï¼Œä»¥ JSON æ ¼å¼è¾“å‡ºã€‚å› ä¸ºè·¨åŸŸé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒéƒ¨ç½²åœ¨æœåŠ¡ç«¯ï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ï¼Œè®©å®¢æˆ·ç«¯è·å–ç›¸å…³ä¿¡æ¯ã€‚

Next.js æä¾›äº†ååˆ†æ–¹ä¾¿çš„ Serverless æ–¹æ¡ˆï¼Œè®©æˆ‘ä»¬å¯ä»¥ç”¨æä½çš„å¼€å‘æˆæœ¬å®ç°ç›¸å…³åŠŸèƒ½ã€‚æœ¬åšå®¢ç”±äºä½¿ç”¨äº† Next.js ä½œä¸ºæŠ€æœ¯æ ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ `pages/api` ä¸‹æ–°å»º `link-preview.ts` è¿™ä¸ªæ–‡ä»¶ï¼Œå¿«é€Ÿå®ç°ä¸€ä¸ª `/api/link-preview` æ¥å£ã€‚

æ³¨æ„ï¼šåœ¨è¯·æ±‚ header ä¸­æˆ‘ä»¬éœ€è¦æ·»åŠ  `"user-agent": "googlebot"`, è¿™æ˜¯ä¸ºäº†è®© link-preview-js å¯ä»¥è·å–å®Œæ•´çš„ og ä¿¡æ¯ã€‚

```ts
import { getLinkPreview } from "link-preview-js";

export default async function linkPreviewHandler(req, res) {
  const { url } = req.query;
  console.info("fetching " + url);
  const data = await getLinkPreview(url, {
    timeout: 10000,
    imagesPropertyType: "og",
    headers: {
      "user-agent": "googlebot", // fetches with googlebot crawler user agent
    },
  });
  res.json(data);
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªè¦åœ¨ React ç»„ä»¶æ¸²æŸ“æ—¶ï¼ŒæŠŠç›¸å…³ URL çš„ OpenGraph Meta æ•°æ®ï¼Œé€šè¿‡ `/api/link-preview?url=` çš„å½¢å¼è·å–å³å¯ã€‚
