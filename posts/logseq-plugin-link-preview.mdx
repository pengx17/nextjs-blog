---
title: "Logseq: å¤–é“¾é¢„è§ˆæ’ä»¶"
date: "2021-10-23"
---

æœ¬ç«™é€šè¿‡ Next.js function + MDX çš„ç»„åˆæ‹³ï¼Œä¸ºæ–‡ç« å†…çš„å¤–é“¾æä¾›äº†**é¼ æ ‡æ‚¬åœ**ä¸**å†…è”å¡ç‰‡**ä¸¤ç§æ¸²æŸ“æ¨¡å¼çš„[é¢„è§ˆæ”¯æŒ](/posts/link-preview)ã€‚å¯¹äº Logseqï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨æ’ä»¶ API ä¸ºå…¶æä¾›ç±»ä¼¼çš„åŠŸèƒ½ã€‚

![](/images/link-preview-screenshot.png)

[åœ¨å‰é¢çš„åšå®¢](/posts/link-preview)é‡Œ, æˆ‘ä»‹ç»äº†å°†ä»»æ„å¤–é“¾æ¸²æŸ“ä¸ºå¡ç‰‡æ¨¡æ¿çš„æ–¹æ³•ã€‚ä¸ºäº†åœ¨
Logseq é‡Œå®ç°ä¸¤ç§æ¸²æŸ“æ¨¡å¼ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è§£å†³å…¶ä»–é—®é¢˜ã€‚

## é¼ æ ‡æ‚¬åœ

### ç›®æ ‡ï¼šå½“é¼ æ ‡ç§»åŠ¨åˆ°å¤–éƒ¨é“¾æ¥æ—¶ï¼Œåœ¨æ‚¬åœä½ç½®æ˜¾ç¤ºé“¾æ¥çš„é¢„è§ˆå›¾ã€‚

Logseq æ’ä»¶ API ç›®å‰æ²¡æœ‰æä¾› `mouseenter` æˆ– `mouseleave` äº‹ä»¶çš„ APIï¼Œä½†æˆ‘ä»¬å¯ä»¥ç›‘å¬ä¸»è§†å›¾ä¸­çš„ `mouseenter` äº‹ä»¶ä½œä¸º <Note label="workaround">è¿™é‡Œè¯·æ³¨æ„ï¼Œå‘å¸ƒåœ¨å¸‚åœºä¸­çš„ Logseq æ’ä»¶é»˜è®¤æƒ…å†µæ˜¯è¿è¡Œåœ¨ç‹¬ç«‹åŸŸåä¸­çš„ `iframe` æ²™ç›’é‡Œï¼Œè®¿é—®ä¸»è§†å›¾ `top` å¼•ç”¨ï¼ˆæŒ‡å‘åˆ°ä¸»è§†å›¾çš„ `window` å¯¹è±¡ï¼‰çš„èƒ½åŠ›è¢«[è·¨åŸŸå®‰å…¨ç­–ç•¥](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy#cross-origin_script_api_access)ç¦æ­¢ï¼Œæˆ‘ä»¬ç›®å‰åªæœ‰åœ¨æœ¬åœ°é€šè¿‡ `Load unpacked plugin` çš„æ–¹å¼åŠ è½½æ’ä»¶ï¼Œæ‰èƒ½è®¿é—®åˆ° `top` å¼•ç”¨ã€‚</Note>ã€‚
å½“äº‹ä»¶ä¸­çš„ `target` ä¸ºå¤–é“¾ (`className === "external-link"`) æ—¶ï¼Œåœ¨é”šç‚¹ä½ç½®æ¸²æŸ“é¢„è§ˆå›¾ã€‚å¦‚ä¸‹çš„ `useHoveringExternalLink` React Hook ä¼šè¿”å›å½“å‰é¼ æ ‡æ‚¬åœçš„å¤–é“¾é”šç‚¹å…ƒç´ ã€‚

```tsx
const useHoveringExternalLink = () => {
  const [anchor, setAnchor] = React.useState<HTMLAnchorElement | null>(null);
  const currentAnchor = React.useRef(anchor);

  React.useEffect(() => {
    const enterAnchorListener = (e: MouseEvent) => {
      const target = e.composedPath()[0] as HTMLAnchorElement;
      if (
        target.tagName === "A" &&
        target.href &&
        target.className.includes("external-link")
      ) {
        setAnchor(target);
        currentAnchor.current = target;
        target.addEventListener(
          "mouseleave",
          () => {
            setAnchor(null);
          },
          { once: true }
        );
      }
    };

    const enterIframeListener = (e: MouseEvent) => {
      setAnchor(currentAnchor.current);
      document.addEventListener(
        "mouseleave",
        () => {
          setAnchor(null);
        },
        { once: true }
      );
    };

    top?.document.addEventListener("mouseenter", enterAnchorListener, true);
    document.addEventListener("mouseenter", enterIframeListener, true);
    return () => {
      top?.document.removeEventListener(
        "mouseenter",
        enterAnchorListener,
        true
      );
      document.removeEventListener("mouseenter", enterIframeListener, true);
    };
  }, []);
  return anchor;
};
```

è§£å†³äº†è·å–å½“å‰æ‚¬åœå¤–é“¾çš„é—®é¢˜åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è°ƒç”¨ `https://logseq-plugin-link-preview.vercel.app/api/link-preview?url=URL` è·å–åˆ°é“¾æ¥çš„å…ƒæ•°æ®ï¼Œç„¶åå°†ç»“æœäº¤ç»™ `<LinkCard />` ç»„ä»¶æ¸²æŸ“ã€‚å¡ç‰‡çš„æ‚¬æµ®ä½ç½®å¯é€šè¿‡å¤–é“¾å…ƒç´ çš„ `getBoundingClientRect`ï¼Œé€šè¿‡ `logseq.setMainUIInlineStyle` åŠ¨æ€è®¾ç½® iframe çš„æ ·å¼ï¼Œä»¥å®ç°æ‚¬åœä½ç½®çš„è‡ªé€‚åº”è°ƒæ•´ã€‚

```tsx
const useAdaptViewPort = (
  data: LinkPreviewMetadata | null,
  anchor: HTMLAnchorElement | null
) => {
  React.useEffect(() => {
    if (data && anchor && top) {
      logseq.showMainUI();
      const elemBoundingRect = anchor.getBoundingClientRect();
      const [width, height] = getCardSize(data);
      let left = (elemBoundingRect.left + elemBoundingRect.right - width) / 2;
      const right = left + width;
      const oversize = Math.max(right - top.visualViewport.width, 0);
      left = Math.max(left - oversize, 0);
      let vOffset =
        elemBoundingRect.top - height > 0
          ? elemBoundingRect.top - height - 8
          : elemBoundingRect.top + elemBoundingRect.height + 8;
      logseq.setMainUIInlineStyle({
        top: vOffset + `px`,
        left: left + `px`,
        width: width + `px`,
        height: height + `px`,
        zIndex: 20,
        filter: "drop-shadow(0 0 12px rgba(0, 0, 0, 0.2))",
        position: "fixed",
      });
    } else {
      logseq.hideMainUI();
    }
  }, [anchor, data]);
};
```

<br />

### é—®é¢˜ï¼šæ‚¬åœå¤–é“¾æ˜¾ç¤ºé¢„è§ˆå›¾æ—¶ç¼–è¾‘ç„¦ç‚¹ä¸¢å¤±

ç”±äºæ’ä»¶ä¸ä¸»è§†å›¾åœ¨ä¸åŒçš„ frame ä¸Šä¸‹æ–‡ï¼Œé¼ æ ‡åœ¨æ‚¬åœå¤–é“¾å¹¶æ˜¾ç¤ºå¡ç‰‡æ—¶ï¼Œé¡µé¢çš„ç„¦ç‚¹ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ‚¬æµ®å¡ç‰‡ä¸Šã€‚è¿™æ ·ä¼šå¯¼è‡´ç¼–è¾‘ç„¦ç‚¹ä¸¢å¤±çš„é—®é¢˜ï¼Œå¤šå°‘ä¼šå½±å“ç”¨æˆ·æ›´è¿è´¯çš„è¾“å…¥ä½“éªŒã€‚

æˆ‘çš„è§£å†³åŠæ³•æ¯”è¾ƒ _hack_ ï¼šåœ¨ `React.useEffect` ä¸­ç›‘å¬æ’ä»¶ä¸Šä¸‹æ–‡ä¸­çš„ `document` çš„ `focus` äº‹ä»¶ã€‚å½“ç„¦ç‚¹åˆ‡æ¢åˆ°æ’ä»¶ä¸»çª—å£æ—¶ï¼Œä¸»åŠ¨æŠŠç„¦ç‚¹é‡æ–°è®¾ç½®ä¸ºä¸»çª—å£ï¼Œå¹¶é€šè¿‡ `logseq.Editor.restoreEditingCursor` è¿˜åŸç¼–è¾‘çŠ¶æ€ã€‚ä»£ç åŒæ ·ä¹Ÿå°è£…æˆäº† React Hookï¼š

```tsx
// Makes sure the user will not lose focus (editing state) when previewing a link
export const usePreventFocus = () => {
  React.useEffect(() => {
    let timer = 0;
    const listener = () => {
      setTimeout(() => {
        if (window.document.hasFocus()) {
          (top as any).focus();
          logseq.Editor.restoreEditingCursor();
        }
      });
    };
    timer = setInterval(listener, 1000);
    window.addEventListener("focus", listener);
    return () => {
      window.removeEventListener("focus", listener);
      clearInterval(timer);
    };
  });
};
```

<br />

## å†…è”å¡ç‰‡

### ç›®æ ‡ï¼šæ³¨å†Œ `/Convert to Link Card` å‘½ä»¤

ç”¨æˆ·è¾“å…¥ URL åï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© `/Convert to Link Card` å‘½ä»¤å°†ç”¨æˆ·è¾“å…¥çš„ URL è½¬åŒ–ä¸º `{{renderer :linkpreview,URL}}` æ–‡æœ¬ï¼Œè¿™æ ·å°±å¯ä»¥å†äº¤ç»™è‡ªå®šä¹‰ Macro ï¼ˆå®ï¼‰ æ¸²æŸ“å†…è”å¤–é“¾å¡ç‰‡äº†ã€‚

```tsx
logseq.Editor.registerSlashCommand("Convert to Link Card ğŸª§", async () => {
  const maybeUrl = (await logseq.Editor.getEditingBlockContent()).trim();
  const id = await logseq.Editor.getCurrentBlock();

  if (urlRegex.test(maybeUrl) && id) {
    const newContent = `{{renderer ${macroPrefix},${maybeUrl}}}`;
    logseq.Editor.updateBlock(id.uuid, newContent);
  } else {
    logseq.App.showMsg(
      "The block content does not seem to be a valid URL",
      "warning"
    );
  }
});
```

### ç›®æ ‡ï¼šè‡ªå®šä¹‰å®(Macro)æ¸²æŸ“

Logseq ä¸­çš„å®ä¸<Note label="ç¼–ç¨‹è¯­è¨€çš„å®æ¦‚å¿µ">ä»¥é¢„å®šä¹‰è§„åˆ™ï¼Œå°†è¾“å…¥æ–‡æœ¬æ›¿æ¢ä¸ºå…¶ä»–çš„æ–‡æœ¬</Note>ç±»ä¼¼ã€‚æˆ‘ä»¬çš„æ¥ä¸‹æ¥çš„ç›®æ ‡å°±æ˜¯å°† `{{renderer :linkpreview,http://www.baidu.com}}` æ–‡æœ¬æ¸²æŸ“æˆç›¸åº” HTML æ¨¡æ¿ï¼š

```html
<a
  rel="noopener noreferrer"
  href="http://www.baidu.com/"
  class="link_preview__root"
  style="width:720px;height:140px"
  ><div class="link_preview__card-container">
    <div class="link_preview__text-container">
      <div class="link_preview__text-container-title">ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“</div>
      <div class="link_preview__text-container-description">
        å…¨çƒé¢†å…ˆçš„ä¸­æ–‡æœç´¢å¼•æ“ã€è‡´åŠ›äºè®©ç½‘æ°‘æ›´ä¾¿æ·åœ°è·å–ä¿¡æ¯ï¼Œæ‰¾åˆ°æ‰€æ±‚ã€‚ç™¾åº¦è¶…è¿‡åƒäº¿çš„ä¸­æ–‡ç½‘é¡µæ•°æ®åº“ï¼Œå¯ä»¥ç¬é—´æ‰¾åˆ°ç›¸å…³çš„æœç´¢ç»“æœã€‚
      </div>
      <div class="link_preview__text-container-url-container">
        <img
          height="16"
          width="16"
          src="http://www.baidu.com/img/baidu_85beaf5496f291521eb75ba38eacbd87.svg"
        /><span class="text-container-url">http://www.baidu.com/</span>
      </div>
    </div>
    <div class="link_preview__cover-container">
      <img
        alt="cover"
        src="http://ss.bdimg.com/static/superman/img/topnav/baiduyun@2x-e0be79e69e.png"
        class="link_preview__cover-image"
      />
    </div></div
></a>
```

å®æ³¨å†Œç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š

```tsx
logseq.App.onMacroRendererSlotted(async ({ payload, slot }) => {
  const [type, url] = payload.arguments;
  if (!type?.startsWith(macroPrefix)) {
    return;
  }

  const render = (data) => {
    const inner = ReactDOMServer.renderToStaticMarkup(
      <LinkCard data={toLinkPreviewMetadata(url, null, data)} />
    );
    logseq.provideUI({
      key: "linkpreview",
      slot,
      reset: true,
      template: `<span data-on-click="openExternalLink" data-url="${url}">${inner}</span>`,
    });
  };

  // æ¸²æŸ“ Loading çŠ¶æ€
  render();

  // è·å¾—å…ƒæ•°æ®åï¼Œæ¸²æŸ“ä¸ºæ ‡å‡†çš„ HTML
  render(await fetchLinkPreviewMetadata(url));
});
```

åˆ©ç”¨ React <Note label="SSR/SSG">SSR å’Œ SSG åˆ†åˆ«æŒ‡ server-side rendering (æœåŠ¡ç«¯æ¸²æŸ“)ä¸ static site generation (é™æ€ç«™ç‚¹ç”Ÿæˆ)ï¼Œ[å‚è€ƒé“¾æ¥](https://nextjs.org/docs/basic-features/pages#two-forms-of-pre-rendering)</Note> ä¸­å¸¸ç”¨çš„ `ReactDOMServer.renderToStaticMarkup` å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¤ç”¨ `LinkCard` React ç»„ä»¶ï¼Œå°† ReactElement è¾“å‡ºä¸º HTML å­—ç¬¦ä¸²ã€‚

### é—®é¢˜ï¼šæä¾›æ¨¡æ¿æ ·å¼

`LinkCard` æ‰€éœ€è¦çš„æ ·å¼ `style.css` é»˜è®¤åªä¼šåœ¨ `iframe` å†…ç”Ÿæ•ˆã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªåŠæ³•ï¼Œå°†ç›¸å…³çš„æ ·å¼ä¹Ÿèƒ½åœ¨ä¸»è§†å›¾ä¸­ç”Ÿæ•ˆã€‚

ç›®å‰ `LinkCard` çš„å®ç°ä¸­ï¼ŒCSS æ˜¯ä»¥å…¨å±€æ ·å¼æ–‡ä»¶ `style.css` æ³¨å…¥åˆ° iframe ä¸Šä¸‹æ–‡çš„ã€‚åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°† `style.css` è¯»å–ä¸ºçº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œé€šè¿‡ `logseq.provideStyle` æ³¨å†Œåˆ°ä¸»è§†å›¾ä¸­ã€‚

## å®Œ

ä»¥ä¸Šæ˜¯ `logseq-plugin-link-preview` æ’ä»¶çš„åŸºæœ¬æ€è·¯ã€‚ä»åŠŸèƒ½æ¥è®²ï¼Œå®ƒå·²ç»æ¯”è¾ƒå®Œæ•´äº†ï¼Œä½†æˆ‘è®¤ä¸ºè¿˜æœ‰ä»¥ä¸‹é—®é¢˜ï¼š

- ç¦» Notion ç­‰æˆç†Ÿäº§å“ä¸­çš„å¤–é“¾é¢„è§ˆåŠŸèƒ½æ¥è¯´è¿˜æœ‰ä¸€å®šå·®è·ã€‚é—®é¢˜è¿˜æ˜¯ä¸»è¦åœ¨äºå¯¹å¤–é“¾å†…å®¹çš„æ­£ç¡®è§£æä¸Šã€‚æ¯”å¦‚ï¼ŒNotion åœ¨å‘ç°ç”¨æˆ·çš„å¤–é“¾æ˜¯ä¸€ä¸ª GitHub çš„ Issue çš„æ—¶å€™ï¼Œä¼šå°è¯•é€šè¿‡ GitHub API è·å– Issue çš„æ ‡é¢˜ã€æè¿°ã€çŠ¶æ€ç­‰ä¿¡æ¯è¿›è¡Œå®šåˆ¶åŒ–æ¸²æŸ“ï¼Œä½†æˆ‘ä»¬å…¶å®åªä¾èµ–äºç›®æ ‡ç½‘ç«™çš„ Open Graph æ ‡ç­¾ï¼Œæ‰€ä»¥èƒ½è·å¾—çš„ä¿¡æ¯ä¸ä¸€å®šè¶³å¤Ÿä¸°å¯Œã€‚
- éœ€è¦ç©¿é€ `iframe` æ²™ç›’ç›´æ¥åœ¨é¡¶å±‚ä¸Šä¸‹æ–‡å†…æ³¨å†Œäº‹ä»¶ã€‚è¿™ä¸€ç‚¹é˜»ç¢äº†æ’ä»¶æ˜¯å¦å¯ä»¥å‘å¸ƒåˆ° Logseq Marketplace ä¸­ã€‚

---

é¡¹ç›®åœ°å€: [logseq-plugin-link-preview](https://github.com/pengx17/logseq-plugin-link-preview)
