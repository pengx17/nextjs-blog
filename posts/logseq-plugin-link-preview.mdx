---
title: "Logseq: å¤–é“¾é¢„è§ˆæ’ä»¶"
date: "2021-10-23"
draft: false
---

æœ¬åšå®¢é€šè¿‡ Next.js function + MDX çš„ç»„åˆæ‹³ï¼Œæä¾›äº†**é¼ æ ‡æ‚¬åœ**ä¸**å†…è”å¡ç‰‡**ä¸¤ç§æ¸²æŸ“æ¨¡å¼çš„[å¤–é“¾é¢„è§ˆçš„æ”¯æŒ](/posts/link-preview)ã€‚é‚£ä¹ˆå¯¹äº Logseqï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨æ’ä»¶ API ä¸º Logseq æä¾›ç±»ä¼¼çš„åŠŸèƒ½ã€‚

è¿™ä¸ª[åœ¨å‰é¢çš„åšå®¢](/posts/link-preview)é‡Œä»‹ç»äº†å°†ä»»æ„å¤–é“¾æ¸²æŸ“ä¸ºå¡ç‰‡æ¨¡æ¿çš„æ–¹æ³•ã€‚ä¸ºäº†åœ¨ Logseq é‡Œå®ç°ä¸¤ç§æ¸²æŸ“æ¨¡å¼ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è§£å†³å…¶ä»–é—®é¢˜ã€‚

## é¼ æ ‡æ‚¬åœ

### ğŸ¯ ç›®æ ‡ï¼šå½“é¼ æ ‡ç§»åŠ¨åˆ°å¤–éƒ¨é“¾æ¥æ—¶ï¼Œåœ¨æ‚¬åœä½ç½®æ˜¾ç¤ºé“¾æ¥çš„é¢„è§ˆå›¾ã€‚

åœ¨ Plugin ä¸­ç›‘å¬ä¸»è§†å›¾ä¸­çš„ `mouseenter` äº‹ä»¶ï¼Œå½“äº‹ä»¶ä¸­çš„ `target` ä¸ºå¤–é“¾ (`className === "external-link"`) æ—¶ï¼Œåœ¨é”šç‚¹ä½ç½®æ˜¾ç¤ºé¢„è§ˆå›¾ã€‚å¦‚ä¸‹çš„ `useHoveringExternalLink` React Hook ä¼šè¿”å›å½“å‰é¼ æ ‡æ‚¬åœçš„å¤–é“¾é”šç‚¹å…ƒç´ ã€‚

```tsx
const useHoveringExternalLink = () => {
  const [anchor, setAnchor] = React.useState<HTMLAnchorElement | null>(null);
  const currentAnchor = React.useRef(anchor);

  React.useEffect(() => {
    const enterAnchorListener = (e: MouseEvent) => {
      const target = e.composedPath()[0] as HTMLAnchorElement;
      if (
        target.tagName === "A" &&
        target.href &&
        target.className.includes("external-link")
      ) {
        setAnchor(target);
        currentAnchor.current = target;
        target.addEventListener(
          "mouseleave",
          () => {
            setAnchor(null);
          },
          { once: true }
        );
      }
    };

    const enterIframeListener = (e: MouseEvent) => {
      setAnchor(currentAnchor.current);
      document.addEventListener(
        "mouseleave",
        () => {
          setAnchor(null);
        },
        { once: true }
      );
    };

    top?.document.addEventListener("mouseenter", enterAnchorListener, true);
    document.addEventListener("mouseenter", enterIframeListener, true);
    return () => {
      top?.document.removeEventListener(
        "mouseenter",
        enterAnchorListener,
        true
      );
      document.removeEventListener("mouseenter", enterIframeListener, true);
    };
  }, []);
  return anchor;
};
```

è¿™é‡Œè¯·æ³¨æ„ï¼ŒLogseq æ’ä»¶é»˜è®¤æƒ…å†µæ˜¯è¿è¡Œåœ¨ `iframe` æ²™ç›’ä¸­çš„ï¼Œè®¿é—®ä¸»è§†å›¾ `top` å¼•ç”¨çš„èƒ½åŠ›åªæœ‰åœ¨æœ¬åœ°é€šè¿‡ `Load unpacked plugin` çš„æ–¹å¼åŠ è½½æ’ä»¶æ—¶æ‰æœ‰æ•ˆã€‚

è§£å†³äº†è·å–å½“å‰æ‚¬åœå¤–é“¾çš„é—®é¢˜åï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ‹¿åˆ°å¤–é“¾å…ƒç´ çš„ `getBoundingClientRect`ï¼Œå°†æ’ä»¶ä¸»çª—å£æ¸²æŸ“åˆ°ç›¸åº”ä½ç½®å³å¯ã€‚

```tsx
const useAdaptViewPort = (
  data: LinkPreviewMetadata | null,
  anchor: HTMLAnchorElement | null
) => {
  React.useEffect(() => {
    if (data && anchor && top) {
      logseq.showMainUI();
      const elemBoundingRect = anchor.getBoundingClientRect();
      const [width, height] = getCardSize(data);
      let left = (elemBoundingRect.left + elemBoundingRect.right - width) / 2;
      const right = left + width;
      const oversize = Math.max(right - top.visualViewport.width, 0);
      left = Math.max(left - oversize, 0);
      let vOffset =
        elemBoundingRect.top - height > 0
          ? elemBoundingRect.top - height - 8
          : elemBoundingRect.top + elemBoundingRect.height + 8;
      logseq.setMainUIInlineStyle({
        top: vOffset + `px`,
        left: left + `px`,
        width: width + `px`,
        height: height + `px`,
        zIndex: 20,
        filter: "drop-shadow(0 0 12px rgba(0, 0, 0, 0.2))",
        position: "fixed",
      });
    } else {
      logseq.hideMainUI();
    }
  }, [anchor, data]);
};
```

<br />

### ğŸ› é—®é¢˜ï¼šæ‚¬åœå¤–é“¾æ˜¾ç¤ºé¢„è§ˆå›¾æ—¶ç¼–è¾‘ç„¦ç‚¹ä¸¢å¤±

ç”±äº `iframe` çš„é—®é¢˜ï¼Œé¼ æ ‡åœ¨æ‚¬åœå¤–é“¾å¹¶æ˜¾ç¤ºå¡ç‰‡æ—¶ï¼Œé¡µé¢çš„ç„¦ç‚¹ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ‚¬æµ®å¡ç‰‡ä¸Šã€‚è¿™æ ·ä¼šå¯¼è‡´ç¼–è¾‘ç„¦ç‚¹ä¸¢å¤±çš„é—®é¢˜ï¼Œå¤šå°‘ä¼šå½±å“ç”¨æˆ·æ›´è¿è´¯çš„è¾“å…¥ä½“éªŒã€‚

è¿™é‡Œæˆ‘çš„è§£å†³åŠæ³•æ¯”è¾ƒ hackï¼šåœ¨ `React.useEffect` ä¸­ç›‘å¬æ’ä»¶ä¸Šä¸‹æ–‡ä¸­çš„ `document` `focus` äº‹ä»¶ã€‚å½“ç„¦ç‚¹åˆ‡æ¢åˆ°æ’ä»¶ä¸»çª—å£æ—¶ï¼Œä¸»åŠ¨æŠŠç„¦ç‚¹é‡æ–°è®¾ä¸ºä¸»çª—å£ï¼Œå¹¶é€šè¿‡ `logseq.Editor.restoreEditingCursor` è¿˜åŸç¼–è¾‘çŠ¶æ€ã€‚ä»£ç åŒæ ·ä¹Ÿå°è£…æˆäº† React Hookï¼š

```tsx
// Makes sure the user will not lose focus (editing state) when previewing a link
export const usePreventFocus = () => {
  React.useEffect(() => {
    let timer = 0;
    const listener = () => {
      setTimeout(() => {
        if (window.document.hasFocus()) {
          (top as any).focus();
          logseq.Editor.restoreEditingCursor();
        }
      });
    };
    timer = setInterval(listener, 1000);
    window.addEventListener("focus", listener);
    return () => {
      window.removeEventListener("focus", listener);
      clearInterval(timer);
    };
  });
};
```

## å†…è”å¡ç‰‡

# References

<Icon name="code" />

[æ’ä»¶é¡¹ç›®æºç ](https://github.com/pengx17/logseq-plugin-link-preview)
